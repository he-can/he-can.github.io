var Vector3={},Matrix44={};Vector3.create=function(t,e,r){return{x:t,y:e,z:r}},Vector3.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},Vector3.cross=function(t,e,r){t.x=e.y*r.z-e.z*r.y,t.y=e.z*r.x-e.x*r.z,t.z=e.x*r.y-e.y*r.x},Vector3.normalize=function(t){var e=t.x*t.x+t.y*t.y+t.z*t.z;1e-5<e&&(e=1/Math.sqrt(e),t.x*=e,t.y*=e,t.z*=e)},Vector3.arrayForm=function(t){return t.array?(t.array[0]=t.x,t.array[1]=t.y,t.array[2]=t.z):t.array=new Float32Array([t.x,t.y,t.z]),t.array},Matrix44.createIdentity=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Matrix44.loadProjection=function(t,e,r,n,o){r=n*Math.tan(r*Math.PI/180*.5)*2,e*=r;t[0]=2*n/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n/r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-(o+n)/(o-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=-2*o*n/(o-n),t[15]=0},Matrix44.loadLookAt=function(t,e,r,n){var o=Vector3.create(e.x-r.x,e.y-r.y,e.z-r.z);Vector3.normalize(o);r=Vector3.create(1,0,0);Vector3.cross(r,n,o),Vector3.normalize(r);n=Vector3.create(1,0,0);Vector3.cross(n,o,r),Vector3.normalize(n),t[0]=r.x,t[1]=n.x,t[2]=o.x,t[3]=0,t[4]=r.y,t[5]=n.y,t[6]=o.y,t[7]=0,t[8]=r.z,t[9]=n.z,t[10]=o.z,t[11]=0,t[12]=-(e.x*t[0]+e.y*t[4]+e.z*t[8]),t[13]=-(e.x*t[1]+e.y*t[5]+e.z*t[9]),t[14]=-(e.x*t[2]+e.y*t[6]+e.z*t[10]),t[15]=1};var gl,timeInfo={start:0,prev:0,delta:0,elapsed:0},renderSpec={width:0,height:0,aspect:1,array:new Float32Array(3),halfWidth:0,halfHeight:0,halfArray:new Float32Array(3)};function deleteRenderTarget(t){gl.deleteFramebuffer(t.frameBuffer),gl.deleteRenderbuffer(t.renderBuffer),gl.deleteTexture(t.texture)}function createRenderTarget(t,e){var r={width:t,height:e,sizeArray:new Float32Array([t,e,t/e]),dtxArray:new Float32Array([1/t,1/e])};return r.frameBuffer=gl.createFramebuffer(),r.renderBuffer=gl.createRenderbuffer(),r.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,r.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,e,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.bindFramebuffer(gl.FRAMEBUFFER,r.frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,r.texture,0),gl.bindRenderbuffer(gl.RENDERBUFFER,r.renderBuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,t,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,r.renderBuffer),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),r}function compileShader(t,e){t=gl.createShader(t);if(gl.shaderSource(t,e),gl.compileShader(t),gl.getShaderParameter(t,gl.COMPILE_STATUS))return t;e=gl.getShaderInfoLog(t);return gl.deleteShader(t),console.error(e),null}function createShader(t,e,r,n){t=compileShader(gl.VERTEX_SHADER,t),e=compileShader(gl.FRAGMENT_SHADER,e);if(null==t||null==e)return null;var o=gl.createProgram();if(gl.attachShader(o,t),gl.attachShader(o,e),gl.deleteShader(t),gl.deleteShader(e),gl.linkProgram(o),!gl.getProgramParameter(o,gl.LINK_STATUS)){e=gl.getProgramInfoLog(o);return console.error(e),null}if(r){o.uniforms={};for(var i=0;i<r.length;i++)o.uniforms[r[i]]=gl.getUniformLocation(o,r[i])}if(n)for(o.attributes={},i=0;i<n.length;i++){var a=n[i];o.attributes[a]=gl.getAttribLocation(o,a)}return o}function useShader(t){for(var e in gl.useProgram(t),t.attributes)gl.enableVertexAttribArray(t.attributes[e])}function unuseShader(t){for(var e in t.attributes)gl.disableVertexAttribArray(t.attributes[e]);gl.useProgram(null)}renderSpec.setSize=function(t,e){renderSpec.width=t,renderSpec.height=e,renderSpec.aspect=renderSpec.width/renderSpec.height,renderSpec.array[0]=renderSpec.width,renderSpec.array[1]=renderSpec.height,renderSpec.array[2]=renderSpec.aspect,renderSpec.halfWidth=Math.floor(t/2),renderSpec.halfHeight=Math.floor(e/2),renderSpec.halfArray[0]=renderSpec.halfWidth,renderSpec.halfArray[1]=renderSpec.halfHeight,renderSpec.halfArray[2]=renderSpec.halfWidth/renderSpec.halfHeight};var projection={angle:60,nearfar:new Float32Array([.1,100]),matrix:Matrix44.createIdentity()},camera={position:Vector3.create(0,0,100),lookat:Vector3.create(0,0,0),up:Vector3.create(0,1,0),dof:Vector3.create(10,4,8),matrix:Matrix44.createIdentity()},pointFlower={},meshFlower={},sceneStandBy=!1,BlossomParticle=function(){this.velocity=new Array(3),this.rotation=new Array(3),this.position=new Array(3),this.euler=new Array(3),this.size=1,this.alpha=1,this.zkey=0};function createPointFlowers(){var t=gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE);renderSpec.pointSize={min:t[0],max:t[1]};var e=document.getElementById("sakura_point_vsh").textContent,t=document.getElementById("sakura_point_fsh").textContent;pointFlower.program=createShader(e,t,["uProjection","uModelview","uResolution","uOffset","uDOF","uFade"],["aPosition","aEuler","aMisc"]),useShader(pointFlower.program),pointFlower.offset=new Float32Array([0,0,0]),pointFlower.fader=Vector3.create(0,10,0),pointFlower.numFlowers=1600,pointFlower.particles=new Array(pointFlower.numFlowers),pointFlower.dataArray=new Float32Array(8*pointFlower.numFlowers),pointFlower.positionArrayOffset=0,pointFlower.eulerArrayOffset=3*pointFlower.numFlowers,pointFlower.miscArrayOffset=6*pointFlower.numFlowers,pointFlower.buffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,pointFlower.buffer),gl.bufferData(gl.ARRAY_BUFFER,pointFlower.dataArray,gl.DYNAMIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),unuseShader(pointFlower.program);for(var r=0;r<pointFlower.numFlowers;r++)pointFlower.particles[r]=new BlossomParticle}function initPointFlowers(){pointFlower.area=Vector3.create(20,20,20),pointFlower.area.x=pointFlower.area.y*renderSpec.aspect,pointFlower.fader.x=10,pointFlower.fader.y=pointFlower.area.z,pointFlower.fader.z=.1;function t(){return 2*Math.random()-1}for(var e,r=2*Math.PI,n=Vector3.create(0,0,0),o=0;o<pointFlower.numFlowers;o++){var i=pointFlower.particles[o];n.x=.3*t()+.8,n.y=.2*t()-1,n.z=.3*t()+.5,Vector3.normalize(n),e=+Math.random()+2,i.setVelocity(n.x*e,n.y*e,n.z*e),i.setRotation(t()*r*.5,t()*r*.5,t()*r*.5),i.setPosition(t()*pointFlower.area.x,t()*pointFlower.area.y,t()*pointFlower.area.z),i.setEulerAngles(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),i.setSize(.9+.1*Math.random())}}function renderPointFlowers(){function t(t,e){t.euler[e]=t.euler[e]%r,t.euler[e]<0&&(t.euler[e]+=r)}for(var r=2*Math.PI,e=(pointFlower.area.x,pointFlower.area.y,pointFlower.area.z,function(t,e,r){Math.abs(t.position[e])-.5*t.size>r&&(0<t.position[e]?t.position[e]-=2*r:t.position[e]+=2*r)}),n=0;n<pointFlower.numFlowers;n++)(l=pointFlower.particles[n]).update(timeInfo.delta,timeInfo.elapsed),e(l,0,pointFlower.area.x),e(l,1,pointFlower.area.y),e(l,2,pointFlower.area.z),t(l,0),t(l,1),t(l,2),l.alpha=1,l.zkey=camera.matrix[2]*l.position[0]+camera.matrix[6]*l.position[1]+camera.matrix[10]*l.position[2]+camera.matrix[14];pointFlower.particles.sort(function(t,e){return t.zkey-e.zkey});for(var o=pointFlower.positionArrayOffset,i=pointFlower.eulerArrayOffset,a=pointFlower.miscArrayOffset,n=0;n<pointFlower.numFlowers;n++){var l=pointFlower.particles[n];pointFlower.dataArray[o]=l.position[0],pointFlower.dataArray[o+1]=l.position[1],pointFlower.dataArray[o+2]=l.position[2],o+=3,pointFlower.dataArray[i]=l.euler[0],pointFlower.dataArray[i+1]=l.euler[1],pointFlower.dataArray[i+2]=l.euler[2],i+=3,pointFlower.dataArray[a]=l.size,pointFlower.dataArray[a+1]=l.alpha,a+=2}gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var c=pointFlower.program;for(useShader(c),gl.uniformMatrix4fv(c.uniforms.uProjection,!1,projection.matrix),gl.uniformMatrix4fv(c.uniforms.uModelview,!1,camera.matrix),gl.uniform3fv(c.uniforms.uResolution,renderSpec.array),gl.uniform3fv(c.uniforms.uDOF,Vector3.arrayForm(camera.dof)),gl.uniform3fv(c.uniforms.uFade,Vector3.arrayForm(pointFlower.fader)),gl.bindBuffer(gl.ARRAY_BUFFER,pointFlower.buffer),gl.bufferData(gl.ARRAY_BUFFER,pointFlower.dataArray,gl.DYNAMIC_DRAW),gl.vertexAttribPointer(c.attributes.aPosition,3,gl.FLOAT,!1,0,pointFlower.positionArrayOffset*Float32Array.BYTES_PER_ELEMENT),gl.vertexAttribPointer(c.attributes.aEuler,3,gl.FLOAT,!1,0,pointFlower.eulerArrayOffset*Float32Array.BYTES_PER_ELEMENT),gl.vertexAttribPointer(c.attributes.aMisc,2,gl.FLOAT,!1,0,pointFlower.miscArrayOffset*Float32Array.BYTES_PER_ELEMENT),n=1;n<2;n++){var f=-2*n;pointFlower.offset[0]=-1*pointFlower.area.x,pointFlower.offset[1]=-1*pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*f,gl.uniform3fv(c.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),pointFlower.offset[0]=-1*pointFlower.area.x,pointFlower.offset[1]=+pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*f,gl.uniform3fv(c.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),pointFlower.offset[0]=+pointFlower.area.x,pointFlower.offset[1]=-1*pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*f,gl.uniform3fv(c.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),pointFlower.offset[0]=+pointFlower.area.x,pointFlower.offset[1]=+pointFlower.area.y,pointFlower.offset[2]=pointFlower.area.z*f,gl.uniform3fv(c.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers)}pointFlower.offset[0]=0,pointFlower.offset[1]=0,pointFlower.offset[2]=0,gl.uniform3fv(c.uniforms.uOffset,pointFlower.offset),gl.drawArrays(gl.POINT,0,pointFlower.numFlowers),gl.bindBuffer(gl.ARRAY_BUFFER,null),unuseShader(c),gl.enable(gl.DEPTH_TEST),gl.disable(gl.BLEND)}function createEffectProgram(t,e,r,n){var o={},i=["uResolution","uSrc","uDelta"];r&&(i=i.concat(r));r=["aPosition"];return n&&(r=r.concat(n)),o.program=createShader(t,e,i,r),useShader(o.program),o.dataArray=new Float32Array([-1,-1,1,-1,-1,1,1,1]),o.buffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,o.buffer),gl.bufferData(gl.ARRAY_BUFFER,o.dataArray,gl.STATIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),unuseShader(o.program),o}function useEffect(t,e){t=t.program;useShader(t),gl.uniform3fv(t.uniforms.uResolution,renderSpec.array),null!=e&&(gl.uniform2fv(t.uniforms.uDelta,e.dtxArray),gl.uniform1i(t.uniforms.uSrc,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture))}function drawEffect(t){gl.bindBuffer(gl.ARRAY_BUFFER,t.buffer),gl.vertexAttribPointer(t.program.attributes.aPosition,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}function unuseEffect(t){unuseShader(t.program)}BlossomParticle.prototype.setVelocity=function(t,e,r){this.velocity[0]=t,this.velocity[1]=e,this.velocity[2]=r},BlossomParticle.prototype.setRotation=function(t,e,r){this.rotation[0]=t,this.rotation[1]=e,this.rotation[2]=r},BlossomParticle.prototype.setPosition=function(t,e,r){this.position[0]=t,this.position[1]=e,this.position[2]=r},BlossomParticle.prototype.setEulerAngles=function(t,e,r){this.euler[0]=t,this.euler[1]=e,this.euler[2]=r},BlossomParticle.prototype.setSize=function(t){this.size=t},BlossomParticle.prototype.update=function(t,e){this.position[0]+=this.velocity[0]*t,this.position[1]+=this.velocity[1]*t,this.position[2]+=this.velocity[2]*t,this.euler[0]+=this.rotation[0]*t,this.euler[1]+=this.rotation[1]*t,this.euler[2]+=this.rotation[2]*t};var effectLib={};function createEffectLib(){var t=document.getElementById("fx_common_vsh").textContent,e=document.getElementById("bg_fsh").textContent;effectLib.sceneBg=createEffectProgram(t,e,["uTimes"],null),e=document.getElementById("fx_brightbuf_fsh").textContent,effectLib.mkBrightBuf=createEffectProgram(t,e,null,null),e=document.getElementById("fx_dirblur_r4_fsh").textContent,effectLib.dirBlur=createEffectProgram(t,e,["uBlurDir"],null),t=document.getElementById("pp_final_vsh").textContent,e=document.getElementById("pp_final_fsh").textContent,effectLib.finalComp=createEffectProgram(t,e,["uBloom"],null)}function createBackground(){}function initBackground(){}function renderBackground(){gl.disable(gl.DEPTH_TEST),useEffect(effectLib.sceneBg,null),gl.uniform2f(effectLib.sceneBg.program.uniforms.uTimes,timeInfo.elapsed,timeInfo.delta),drawEffect(effectLib.sceneBg),unuseEffect(effectLib.sceneBg),gl.enable(gl.DEPTH_TEST)}var postProcess={};function createPostProcess(){}function initPostProcess(){}function renderPostProcess(){gl.enable(gl.TEXTURE_2D),gl.disable(gl.DEPTH_TEST);function t(t,e){gl.bindFramebuffer(gl.FRAMEBUFFER,t.frameBuffer),gl.viewport(0,0,t.width,t.height),e&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT))}t(renderSpec.wHalfRT0,!0),useEffect(effectLib.mkBrightBuf,renderSpec.mainRT),drawEffect(effectLib.mkBrightBuf),unuseEffect(effectLib.mkBrightBuf);for(var e=0;e<2;e++){var r=+e+1.5,n=+e+2;t(renderSpec.wHalfRT1,!0),useEffect(effectLib.dirBlur,renderSpec.wHalfRT0),gl.uniform4f(effectLib.dirBlur.program.uniforms.uBlurDir,r,0,n,0),drawEffect(effectLib.dirBlur),unuseEffect(effectLib.dirBlur),t(renderSpec.wHalfRT0,!0),useEffect(effectLib.dirBlur,renderSpec.wHalfRT1),gl.uniform4f(effectLib.dirBlur.program.uniforms.uBlurDir,0,r,0,n),drawEffect(effectLib.dirBlur),unuseEffect(effectLib.dirBlur)}gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,renderSpec.width,renderSpec.height),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),useEffect(effectLib.finalComp,renderSpec.mainRT),gl.uniform1i(effectLib.finalComp.program.uniforms.uBloom,1),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,renderSpec.wHalfRT0.texture),drawEffect(effectLib.finalComp),unuseEffect(effectLib.finalComp),gl.enable(gl.DEPTH_TEST)}var SceneEnv={};function createScene(){createEffectLib(),createBackground(),createPointFlowers(),createPostProcess(),sceneStandBy=!0}function initScene(){initBackground(),initPointFlowers(),initPostProcess(),camera.position.z=pointFlower.area.z+projection.nearfar[0],projection.angle=180*Math.atan2(pointFlower.area.y,camera.position.z+pointFlower.area.z)/Math.PI*2,Matrix44.loadProjection(projection.matrix,renderSpec.aspect,projection.angle,projection.nearfar[0],projection.nearfar[1])}function renderScene(){Matrix44.loadLookAt(camera.matrix,camera.position,camera.lookat,camera.up),gl.enable(gl.DEPTH_TEST),gl.bindFramebuffer(gl.FRAMEBUFFER,renderSpec.mainRT.frameBuffer),gl.viewport(0,0,renderSpec.mainRT.width,renderSpec.mainRT.height),gl.clearColor(.005,0,.05,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),renderBackground(),renderPointFlowers(),renderPostProcess()}function onResize(t){makeCanvasFullScreen(document.getElementById("sakura")),setViewports(),sceneStandBy&&initScene()}function setViewports(){renderSpec.setSize(gl.canvas.width,gl.canvas.height),gl.clearColor(.2,.2,.5,1),gl.viewport(0,0,renderSpec.width,renderSpec.height);function t(t,e,r){var n=renderSpec[t];n&&deleteRenderTarget(n),renderSpec[t]=createRenderTarget(e,r)}t("mainRT",renderSpec.width,renderSpec.height),t("wFullRT0",renderSpec.width,renderSpec.height),t("wFullRT1",renderSpec.width,renderSpec.height),t("wHalfRT0",renderSpec.halfWidth,renderSpec.halfHeight),t("wHalfRT1",renderSpec.halfWidth,renderSpec.halfHeight)}function render(){renderScene()}var animating=!0;function toggleAnimation(t){(animating^=!0)&&animate(),t&&(t.innerHTML=animating?"Stop":"Start")}function stepAnimation(){animating||animate()}function animate(){var t=new Date;timeInfo.elapsed=(t-timeInfo.start)/1e3,timeInfo.delta=(t-timeInfo.prev)/1e3,timeInfo.prev=t,animating&&requestAnimationFrame(animate),render()}function makeCanvasFullScreen(t){var e=document.body,r=document.documentElement;fullw=Math.max(e.clientWidth,e.scrollWidth,r.scrollWidth,r.clientWidth),fullh=Math.max(e.clientHeight,e.scrollHeight,r.scrollHeight,r.clientHeight),t.width=fullw,t.height=fullh}window.addEventListener("load",function(t){var e=document.getElementById("sakura");try{makeCanvasFullScreen(e),gl=e.getContext("experimental-webgl")}catch(t){return alert("WebGL not supported."+t),void console.error(t)}window.addEventListener("resize",onResize),setViewports(),createScene(),initScene(),timeInfo.start=new Date,timeInfo.prev=timeInfo.start,animate()}),function(e,t){e["r"+t]=e["r"+t]||e["webkitR"+t]||e["mozR"+t]||e["msR"+t]||e["oR"+t]||function(t){e.setTimeout(t,1e3/60)}}(window,"equestAnimationFrame"),document.write('<script id="pp_final_fsh" type="x-shader/x_fragment">#ifdef GL_ES\n\t\t//precision mediump float;\n\t\tprecision highp float;\n\t\t#endif\n\t\tuniform sampler2D uSrc;\n\t\tuniform sampler2D uBloom;\n\t\tuniform vec2 uDelta;\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\t\tvoid main(void) {\n\t\tvec4 srccol = texture2D(uSrc, texCoord) * 2.0;\n\t\tvec4 bloomcol = texture2D(uBloom, texCoord);\n\t\tvec4 col;\n\t\tcol = srccol + bloomcol * (vec4(1.0) + srccol);\n\t\tcol *= smoothstep(1.0, 0.0, pow(length((texCoord - vec2(0.5)) * 2.0), 1.2) * 0.5);\n\t\tcol = pow(col, vec4(0.45454545454545)); //(1.0 / 2.2)\n\n\t\tgl_FragColor = vec4(col.rgb, 1.0);\n\t\tgl_FragColor.a = 1.0;\n\t\t}<\/script>'),document.write('<script id="pp_final_vsh" type="x-shader/x_vertex">\n\t\tuniform vec3 uResolution;\n\t\tattribute vec2 aPosition;\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\t\tvoid main(void) {\n\t\tgl_Position = vec4(aPosition, 0.0, 1.0);\n\t\ttexCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);\n\t\tscreenCoord = aPosition.xy * vec2(uResolution.z, 1.0);\n\t\t}\n\t<\/script>'),document.write('<script id="fx_common_fsh" type="x-shader/x_fragment">\n\t\t#ifdef GL_ES\n\t\t//precision mediump float;\n\t\tprecision highp float;\n\t\t#endif\n\t\tuniform sampler2D uSrc;\n\t\tuniform vec2 uDelta;\n\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\n\t\tvoid main(void) {\n\t\tgl_FragColor = texture2D(uSrc, texCoord);\n\t\t}\n\t<\/script>'),document.write('<script id="fx_dirblur_r4_fsh" type="x-shader/x_fragment">\n\t\t#ifdef GL_ES\n\t\t//precision mediump float;\n\t\tprecision highp float;\n\t\t#endif\n\t\tuniform sampler2D uSrc;\n\t\tuniform vec2 uDelta;\n\t\tuniform vec4 uBlurDir; //dir(x, y), stride(z, w)\n\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\n\t\tvoid main(void) {\n\t\tvec4 col = texture2D(uSrc, texCoord);\n\t\tcol = col + texture2D(uSrc, texCoord + uBlurDir.xy * uDelta);\n\t\tcol = col + texture2D(uSrc, texCoord - uBlurDir.xy * uDelta);\n\t\tcol = col + texture2D(uSrc, texCoord + (uBlurDir.xy + uBlurDir.zw) * uDelta);\n\t\tcol = col + texture2D(uSrc, texCoord - (uBlurDir.xy + uBlurDir.zw) * uDelta);\n\t\tgl_FragColor = col / 5.0;\n\t\t}\n\t<\/script>'),document.write('<script id="fx_brightbuf_fsh" type="x-shader/x_fragment">\n\t\t#ifdef GL_ES\n\t\t//precision mediump float;\n\t\tprecision highp float;\n\t\t#endif\n\t\tuniform sampler2D uSrc;\n\t\tuniform vec2 uDelta;\n\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\n\t\tvoid main(void) {\n\t\tvec4 col = texture2D(uSrc, texCoord);\n\t\tgl_FragColor = vec4(col.rgb * 2.0 - vec3(0.5), 1.0);\n\t\t}\n\t<\/script>'),document.write('<script id="bg_fsh" type="x-shader/x_fragment">\n\t\t#ifdef GL_ES\n\t\t//precision mediump float;\n\t\tprecision highp float;\n\t\t#endif\n\n\t\tuniform vec2 uTimes;\n\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\n\t\tvoid main(void) {\n\t\tvec3 col;\n\t\tfloat c;\n\t\tvec2 tmpv = texCoord * vec2(0.8, 1.0) - vec2(0.95, 1.0);\n\t\tc = exp(-pow(length(tmpv) * 1.8, 2.0));\n\t\tcol = mix(vec3(0.02, 0.0, 0.03), vec3(0.96, 0.98, 1.0) * 1.5, c);\n\t\tgl_FragColor = vec4(col * 0.5, 1.0);\n\t\t}\n\t<\/script>'),document.write('<script id="fx_common_vsh" type="x-shader/x_vertex">\n\t\tuniform vec3 uResolution;\n\t\tattribute vec2 aPosition;\n\n\t\tvarying vec2 texCoord;\n\t\tvarying vec2 screenCoord;\n\n\t\tvoid main(void) {\n\t\tgl_Position = vec4(aPosition, 0.0, 1.0);\n\t\ttexCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);\n\t\tscreenCoord = aPosition.xy * vec2(uResolution.z, 1.0);\n\t\t}\n\t<\/script>'),document.write('<script id="sakura_point_fsh" type="x-shader/x_fragment">\n\t\t#ifdef GL_ES\n\t\t//precision mediump float;\n\t\tprecision highp float;\n\t\t#endif\n\n\t\tuniform vec3 uDOF;  //x:focus distance, y:focus radius, z:max radius\n\t\tuniform vec3 uFade; //x:start distance, y:half distance, z:near fade start\n\n\t\tconst vec3 fadeCol = vec3(0.08, 0.03, 0.06);\n\n\t\tvarying vec3 pposition;\n\t\tvarying float psize;\n\t\tvarying float palpha;\n\t\tvarying float pdist;\n\n\t\t//varying mat3 rotMat;\n\t\tvarying vec3 normX;\n\t\tvarying vec3 normY;\n\t\tvarying vec3 normZ;\n\t\tvarying vec3 normal;\n\n\t\tvarying float diffuse;\n\t\tvarying float specular;\n\t\tvarying float rstop;\n\t\tvarying float distancefade;\n\n\t\tfloat ellipse(vec2 p, vec2 o, vec2 r) {\n\t\tvec2 lp = (p - o) / r;\n\t\treturn length(lp) - 1.0;\n\t\t}\n\n\t\tvoid main(void) {\n\t\tvec3 p = vec3(gl_PointCoord - vec2(0.5, 0.5), 0.0) * 2.0;\n\t\tvec3 d = vec3(0.0, 0.0, -1.0);\n\t\tfloat nd = normZ.z; //dot(-normZ, d);\n\t\tif(abs(nd) < 0.0001) discard;\n\n\t\tfloat np = dot(normZ, p);\n\t\tvec3 tp = p + d * np / nd;\n\t\tvec2 coord = vec2(dot(normX, tp), dot(normY, tp));\n\n\t\t//angle = 15 degree\n\t\tconst float flwrsn = 0.258819045102521;\n\t\tconst float flwrcs = 0.965925826289068;\n\t\tmat2 flwrm = mat2(flwrcs, -flwrsn, flwrsn, flwrcs);\n\t\tvec2 flwrp = vec2(abs(coord.x), coord.y) * flwrm;\n\n\t\tfloat r;\n\t\tif(flwrp.x < 0.0) {\n\t\tr = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.36, 0.96) * 0.5);\n\t\t}\n\t\telse {\n\t\tr = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.58, 0.96) * 0.5);\n\t\t}\n\n\t\tif(r > rstop) discard;\n\n\t\tvec3 col = mix(vec3(1.0, 0.8, 0.75), vec3(1.0, 0.9, 0.87), r);\n\t\tfloat grady = mix(0.0, 1.0, pow(coord.y * 0.5 + 0.5, 0.35));\n\t\tcol *= vec3(1.0, grady, grady);\n\t\tcol *= mix(0.8, 1.0, pow(abs(coord.x), 0.3));\n\t\tcol = col * diffuse + specular;\n\n\t\tcol = mix(fadeCol, col, distancefade);\n\n\t\tfloat alpha = (rstop > 0.001)? (0.5 - r / (rstop * 2.0)) : 1.0;\n\t\talpha = smoothstep(0.0, 1.0, alpha) * palpha;\n\n\t\tgl_FragColor = vec4(col * 0.5, alpha);\n\t\t}\n\t<\/script>'),document.write('<script id="sakura_point_vsh" type="x-shader/x_vertex">\n\t\tuniform mat4 uProjection;\n\t\tuniform mat4 uModelview;\n\t\tuniform vec3 uResolution;\n\t\tuniform vec3 uOffset;\n\t\tuniform vec3 uDOF;  //x:focus distance, y:focus radius, z:max radius\n\t\tuniform vec3 uFade; //x:start distance, y:half distance, z:near fade start\n\n\t\tattribute vec3 aPosition;\n\t\tattribute vec3 aEuler;\n\t\tattribute vec2 aMisc; //x:size, y:fade\n\n\t\tvarying vec3 pposition;\n\t\tvarying float psize;\n\t\tvarying float palpha;\n\t\tvarying float pdist;\n\n\t\t//varying mat3 rotMat;\n\t\tvarying vec3 normX;\n\t\tvarying vec3 normY;\n\t\tvarying vec3 normZ;\n\t\tvarying vec3 normal;\n\n\t\tvarying float diffuse;\n\t\tvarying float specular;\n\t\tvarying float rstop;\n\t\tvarying float distancefade;\n\n\t\tvoid main(void) {\n\t\t// Projection is based on vertical angle\n\t\tvec4 pos = uModelview * vec4(aPosition + uOffset, 1.0);\n\t\tgl_Position = uProjection * pos;\n\t\tgl_PointSize = aMisc.x * uProjection[1][1] / -pos.z * uResolution.y * 0.5;\n\n\t\tpposition = pos.xyz;\n\t\tpsize = aMisc.x;\n\t\tpdist = length(pos.xyz);\n\t\tpalpha = smoothstep(0.0, 1.0, (pdist - 0.1) / uFade.z);\n\n\t\tvec3 elrsn = sin(aEuler);\n\t\tvec3 elrcs = cos(aEuler);\n\t\tmat3 rotx = mat3(\n\t\t1.0, 0.0, 0.0,\n\t\t0.0, elrcs.x, elrsn.x,\n\t\t0.0, -elrsn.x, elrcs.x\n\t\t);\n\t\tmat3 roty = mat3(\n\t\telrcs.y, 0.0, -elrsn.y,\n\t\t0.0, 1.0, 0.0,\n\t\telrsn.y, 0.0, elrcs.y\n\t\t);\n\t\tmat3 rotz = mat3(\n\t\telrcs.z, elrsn.z, 0.0, \n\t\t-elrsn.z, elrcs.z, 0.0,\n\t\t0.0, 0.0, 1.0\n\t\t);\n\t\tmat3 rotmat = rotx * roty * rotz;\n\t\tnormal = rotmat[2];\n\n\t\tmat3 trrotm = mat3(\n\t\trotmat[0][0], rotmat[1][0], rotmat[2][0],\n\t\trotmat[0][1], rotmat[1][1], rotmat[2][1],\n\t\trotmat[0][2], rotmat[1][2], rotmat[2][2]\n\t\t);\n\t\tnormX = trrotm[0];\n\t\tnormY = trrotm[1];\n\t\tnormZ = trrotm[2];\n\n\t\tconst vec3 lit = vec3(0.6917144638660746, 0.6917144638660746, -0.20751433915982237);\n\n\t\tfloat tmpdfs = dot(lit, normal);\n\t\tif(tmpdfs < 0.0) {\n\t\tnormal = -normal;\n\t\ttmpdfs = dot(lit, normal);\n\t\t}\n\t\tdiffuse = 0.4 + tmpdfs;\n\n\t\tvec3 eyev = normalize(-pos.xyz);\n\t\tif(dot(eyev, normal) > 0.0) {\n\t\tvec3 hv = normalize(eyev + lit);\n\t\tspecular = pow(max(dot(hv, normal), 0.0), 20.0);\n\t\t}\n\t\telse {\n\t\tspecular = 0.0;\n\t\t}\n\n\t\trstop = clamp((abs(pdist - uDOF.x) - uDOF.y) / uDOF.z, 0.0, 1.0);\n\t\trstop = pow(rstop, 0.5);\n\t\t//-0.69315 = ln(0.5)\n\t\tdistancefade = min(1.0, exp((uFade.x - pdist) * 0.69315 / uFade.y));\n\t\t}\n\t<\/script>');